<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sierra Suites - Pro CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --enterprise: #9b59b6;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .sidebar {
            background-color: var(--primary);
            color: white;
            height: 100vh;
            position: fixed;
            padding-top: 60px;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            padding-top: 80px;
        }
        
        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .crm-card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            background: white;
            transition: transform 0.2s;
        }
        
        .crm-card:hover {
            transform: translateY(-5px);
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            margin: 5px 0;
            border-radius: 5px;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .badge-residential {
            background-color: #3498db;
            color: white;
        }
        
        .badge-commercial {
            background-color: #2ecc71;
            color: white;
        }
        
        .badge-government {
            background-color: #9b59b6;
            color: white;
        }
        
        .pipeline-stage {
            min-height: 500px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .lead-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: grab;
        }
        
        .enterprise-feature {
            position: relative;
            overflow: hidden;
        }
        
        .enterprise-feature::after {
            content: "Enterprise Feature";
            position: absolute;
            top: 10px;
            right: -35px;
            background: var(--enterprise);
            color: white;
            padding: 5px 40px;
            font-size: 12px;
            transform: rotate(45deg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .upgrade-prompt {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .drag-over {
            background-color: rgba(52, 152, 219, 0.2);
            border: 2px dashed var(--secondary);
        }
        
        #emailResponse {
            min-height: 150px;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 0.75rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        }
        
        .login-card {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }
    </style>
</head>
<body>
    <!-- Login Screen (initially visible) -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="text-center mb-4">
                <img src="https://via.placeholder.com/100x40/3498db/ffffff?text=Sierra+Suites" alt="Sierra Suites" class="mb-3">
                <h3>CRM Dashboard</h3>
                <p class="text-muted">Sign in to access your account</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="loginEmail" class="form-label">Email address</label>
                    <input type="email" class="form-control" id="loginEmail" required>
                </div>
                <div class="mb-3">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Sign In</button>
            </form>
            <div class="text-center mt-3">
                <p class="mb-0">Don't have an account? <a href="#" id="showSignUp">Sign up</a></p>
            </div>
        </div>
    </div>

    <!-- Sign Up Screen (initially hidden) -->
    <div id="signupScreen" class="login-container" style="display: none;">
        <div class="login-card">
            <div class="text-center mb-4">
                <img src="https://via.placeholder.com/100x40/3498db/ffffff?text=Sierra+Suites" alt="Sierra Suites" class="mb-3">
                <h3>Create Account</h3>
                <p class="text-muted">Sign up for a new account</p>
            </div>
            <form id="signupForm">
                <div class="mb-3">
                    <label for="signupName" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="signupName" required>
                </div>
                <div class="mb-3">
                    <label for="signupEmail" class="form-label">Email address</label>
                    <input type="email" class="form-control" id="signupEmail" required>
                </div>
                <div class="mb-3">
                    <label for="signupPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" id="signupPassword" required>
                </div>
                <div class="mb-3">
                    <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                    <input type="password" class="form-control" id="signupConfirmPassword" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Sign Up</button>
            </form>
            <div class="text-center mt-3">
                <p class="mb-0">Already have an account? <a href="#" id="showLogin">Sign in</a></p>
            </div>
        </div>
    </div>

    <!-- Main Application (initially hidden) -->
    <div id="appContainer" style="display: none;">
        <!-- Navigation Sidebar -->
        <div class="sidebar col-md-2 col-lg-2 d-md-block">
            <div class="position-sticky">
                <div class="text-center mb-4">
                    <h4>Sierra Suites CRM</h4>
                    <div class="badge bg-success">PRO TIER</div>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#contacts" data-bs-toggle="tab">
                            <i class="fas fa-users me-2"></i> Contacts
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#pipeline" data-bs-toggle="tab">
                            <i class="fas fa-project-diagram me-2"></i> Pipeline
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#quotes" data-bs-toggle="tab">
                            <i class="fas fa-file-invoice-dollar me-2"></i> Quotes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#activities" data-bs-toggle="tab">
                            <i class="fas fa-history me-2"></i> Activities
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#scheduling" data-bs-toggle="tab">
                            <i class="fas fa-calendar-alt me-2"></i> Scheduling
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#emails" data-bs-toggle="tab">
                            <i class="fas fa-envelope me-2"></i> Smart Emails
                        </a>
                    </li>
                    <li class="nav-item mt-4">
                        <div class="upgrade-prompt">
                            <h6>Ready for more?</h6>
                            <p>Upgrade to Enterprise for advanced features</p>
                            <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#enterpriseModal">Explore Enterprise</button>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg navbar-light fixed-top">
                <div class="container-fluid">
                    <button class="navbar-toggler" type="button">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <form class="d-flex ms-auto">
                        <input class="form-control me-2" type="search" placeholder="Search contacts, projects..." aria-label="Search">
                        <button class="btn btn-outline-secondary" type="submit">Search</button>
                    </form>
                    <div class="dropdown ms-3">
                        <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-plus me-1"></i> New
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item" href="#" id="newContact">New Contact</a></li>
                            <li><a class="dropdown-item" href="#" id="newLead">New Lead</a></li>
                            <li><a class="dropdown-item" href="#" id="newQuote">New Quote</a></li>
                        </ul>
                    </div>
                    <div class="dropdown ms-3">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="https://ui-avatars.com/api/?name=User+Name&background=3498db&color=fff" class="rounded-circle me-1" width="30" height="30" alt="User">
                            <span id="userName">User</span>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i> Profile</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Contacts Tab -->
                <div class="tab-pane fade show active" id="contacts">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Contact Management</h2>
                        <div>
                            <button class="btn btn-outline-secondary me-2"><i class="fas fa-filter"></i> Filter</button>
                            <button class="btn btn-outline-secondary"><i class="fas fa-download"></i> Export</button>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="crm-card p-3 text-center">
                                <h5>Total Contacts</h5>
                                <h3 class="text-primary" id="totalContacts">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="crm-card p-3 text-center">
                                <h5>Clients</h5>
                                <h3 class="text-success" id="totalClients">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="crm-card p-3 text-center">
                                <h5>Leads</h5>
                                <h3 class="text-warning" id="totalLeads">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="crm-card p-3 text-center">
                                <h5>Suppliers</h5>
                                <h3 class="text-info" id="totalSuppliers">0</h3>
                            </div>
                        </div>
                    </div>

                    <div class="crm-card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>All Contacts</h4>
                            <div class="btn-group">
                                <button class="btn btn-outline-primary active filter-btn" data-filter="all">All</button>
                                <button class="btn btn-outline-primary filter-btn" data-filter="residential">Residential</button>
                                <button class="btn btn-outline-primary filter-btn" data-filter="commercial">Commercial</button>
                                <button class="btn btn-outline-primary filter-btn" data-filter="government">Government</button>
                            </div>
                        </div>
                        
                        <table class="table table-hover" id="contactsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Role</th>
                                    <th>Projects</th>
                                    <th>Last Contact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="contactsBody">
                                <!-- Contacts will be loaded here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pipeline Tab -->
                <div class="tab-pane fade" id="pipeline">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Lead Pipeline</h2>
                        <div>
                            <select class="form-select me-2 d-inline-block" id="pipelineFilter" style="width: auto;">
                                <option value="all">All Sales Reps</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                            <button class="btn btn-outline-secondary" id="pipelineAnalyticsBtn"><i class="fas fa-chart-bar"></i> Analytics</button>
                        </div>
                    </div>

                    <div class="row" id="pipelineStages">
                        <!-- Pipeline stages will be loaded here dynamically -->
                    </div>

                    <div class="crm-card p-4 mt-4 d-none" id="pipelineAnalytics">
                        <h4 class="mb-4">Pipeline Analytics</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Conversion Rate</h6>
                                <div class="progress mb-3">
                                    <div class="progress-bar" role="progressbar" style="width: 35%;" aria-valuenow="35" aria-valuemin="0" aria-valuemax="100">35%</div>
                                </div>
                                
                                <h6>Average Deal Size</h6>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>$25,000</span>
                                    <span class="text-success">+12% <i class="fas fa-arrow-up"></i></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Sales by Type</h6>
                                <div class="mb-2 d-flex justify-content-between">
                                    <span>Residential</span>
                                    <span>52%</span>
                                </div>
                                <div class="mb-2 d-flex justify-content-between">
                                    <span>Commercial</span>
                                    <span>36%</span>
                                </div>
                                <div class="mb-2 d-flex justify-content-between">
                                    <span>Government</span>
                                    <span>12%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quotes Tab -->
                <div class="tab-pane fade" id="quotes">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Quote & Proposal Tracking</h2>
                        <button class="btn btn-primary" id="newQuoteBtn"><i class="fas fa-plus me-1"></i> New Quote</button>
                    </div>

                    <div class="crm-card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>All Quotes</h4>
                            <div class="btn-group">
                                <button class="btn btn-outline-primary active">All</button>
                                <button class="btn btn-outline-primary">Draft</button>
                                <button class="btn btn-outline-primary">Sent</button>
                                <button class="btn btn-outline-primary">Approved</button>
                                <button class="btn btn-outline-primary">Rejected</button>
                            </div>
                        </div>
                        
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Quote #</th>
                                    <th>Client</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quotesBody">
                                <!-- Quotes will be loaded here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Activities Tab -->
                <div class="tab-pane fade" id="activities">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Activity Log</h2>
                        <button class="btn btn-primary" id="logActivityBtn"><i class="fas fa-plus me-1"></i> Log Activity</button>
                    </div>

                    <div class="crm-card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>Recent Activities</h4>
                            <select class="form-select" style="width: auto;" id="activityFilter">
                                <option value="all">All Activities</option>
                                <option value="call">Calls</option>
                                <option value="email">Emails</option>
                                <option value="meeting">Meetings</option>
                                <option value="site_visit">Site Visits</option>
                            </select>
                        </div>
                        
                        <div id="activitiesList">
                            <!-- Activities will be loaded here dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Scheduling Tab -->
                <div class="tab-pane fade" id="scheduling">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Jobsite Visit Scheduling</h2>
                        <button class="btn btn-primary" id="scheduleVisitBtn"><i class="fas fa-plus me-1"></i> Schedule Visit</button>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="crm-card p-4">
                                <div id="calendar"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="crm-card p-4">
                                <h4>Upcoming Visits</h4>
                                <div id="upcomingVisits">
                                    <!-- Upcoming visits will be loaded here dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emails Tab -->
                <div class="tab-pane fade" id="emails">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Smart Email Responses</h2>
                        <button class="btn btn-primary" id="newEmailBtn"><i class="fas fa-plus me-1"></i> Compose</button>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="crm-card p-3">
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" placeholder="Search emails...">
                                    <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                                </div>
                                <div id="emailList">
                                    <!-- Email list will be loaded here dynamically -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="crm-card p-4">
                                <div class="mb-3">
                                    <label class="form-label">Email Context</label>
                                    <textarea class="form-control" id="emailContext" rows="3" placeholder="Paste the email you received or describe the situation..."></textarea>
                                </div>
                                <button class="btn btn-primary mb-3" id="generateResponseBtn"><i class="fas fa-magic me-1"></i> Generate Response</button>
                                
                                <div class="mb-3">
                                    <label class="form-label">AI-Suggested Response</label>
                                    <div class="form-control" id="emailResponse" contenteditable="true">
                                        <!-- AI response will appear here -->
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-outline-secondary me-2" id="copyEmailBtn"><i class="fas fa-copy"></i> Copy</button>
                                    <button class="btn btn-primary" id="sendEmailBtn"><i class="fas fa-paper-plane"></i> Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enterprise Upgrade Modal -->
            <div class="modal fade" id="enterpriseModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-enterprise text-white">
                            <h5 class="modal-title">Upgrade to Enterprise</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Enterprise Features</h5>
                                    <ul class="list-group">
                                        <li class="list-group-item">Advanced Reporting & Analytics</li>
                                        <li class="list-group-item">Customizable Workflows</li>
                                        <li class="list-group-item">Multi-team Collaboration</li>
                                        <li class="list-group-item">API Access</li>
                                        <li class="list-group-item">Priority Support</li>
                                        <li class="list-group-item">Advanced AI Features</li>
                                        <li class="list-group-item">Custom Branding</li>
                                        <li class="list-group-item">White-label Solutions</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <div class="crm-card p-3 text-center">
                                        <h5>Enterprise Plan</h5>
                                        <h3>$149/month</h3>
                                        <p>All Pro features plus:</p>
                                        <ul class="text-start">
                                            <li>Unlimited projects</li>
                                            <li>Advanced analytics</li>
                                            <li>Priority support</li>
                                            <li>Custom integrations</li>
                                        </ul>
                                        <button class="btn btn-primary">Upgrade Now</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Setup Notification -->
            <div class="toast-container position-fixed bottom-0 end-0 p-3">
                <div id="dbToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="fas fa-database me-2"></i>
                        <strong class="me-auto">Database Setup</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body" id="dbToastMessage">
                        Checking database tables...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Supabase with your credentials
        const supabaseUrl = 'https://qjswuwcqyzeuqqqltykz.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqc3d1d2NxeXpldXFxcWx0eWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjk0MDUsImV4cCI6MjA3MDgwNTQwNX0.qgH8DMJEoJVuYOXSyr0RAj01Yt7bBR8EYL6qw3YXyAs';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // DOM elements
        const loginScreen = document.getElementById('loginScreen');
        const signupScreen = document.getElementById('signupScreen');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const showSignUp = document.getElementById('showSignUp');
        const showLogin = document.getElementById('showLogin');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const contactsBody = document.getElementById('contactsBody');
        const pipelineStages = document.getElementById('pipelineStages');
        const dbToast = new bootstrap.Toast(document.getElementById('dbToast'));
        const dbToastMessage = document.getElementById('dbToastMessage');
        const generateResponseBtn = document.getElementById('generateResponseBtn');
        const emailResponse = document.getElementById('emailResponse');
        const emailContext = document.getElementById('emailContext');
        const copyEmailBtn = document.getElementById('copyEmailBtn');
        const sendEmailBtn = document.getElementById('sendEmailBtn');
        
        // Show database notification
        function showDbNotification(message, isError = false) {
            dbToastMessage.innerHTML = message;
            dbToastMessage.style.color = isError ? '#e74c3c' : '#2c3e50';
            dbToast.show();
        }

        // Check authentication state
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                // User is signed in
                loginScreen.style.display = 'none';
                signupScreen.style.display = 'none';
                appContainer.style.display = 'block';
                
                // Set user name
                userName.textContent = session.user.email;
                
                // Setup database and load data
                setupDatabase();
            } else if (event === 'SIGNED_OUT') {
                // User is signed out
                loginScreen.style.display = 'flex';
                signupScreen.style.display = 'none';
                appContainer.style.display = 'none';
            }
        });

        // Login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const { user, error } = await supabase.auth.signIn({
                email: email,
                password: password,
            });
            
            if (error) {
                showDbNotification('Login error: ' + error.message, true);
            } else {
                showDbNotification('Login successful! Loading your data...');
            }
        });

        // Signup form submission
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showDbNotification('Passwords do not match', true);
                return;
            }
            
            const { user, error } = await supabase.auth.signUp({
                email: email,
                password: password,
            });
            
            if (error) {
                showDbNotification('Signup error: ' + error.message, true);
            } else {
                showDbNotification('Signup successful! Please check your email for verification.');
                // Switch to login screen
                showLogin.click();
            }
        });

        // Show signup form
        showSignUp.addEventListener('click', (e) => {
            e.preventDefault();
            loginScreen.style.display = 'none';
            signupScreen.style.display = 'flex';
        });

        // Show login form
        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            signupScreen.style.display = 'none';
            loginScreen.style.display = 'flex';
        });

        // Logout button
        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const { error } = await supabase.auth.signOut();
            if (error) {
                showDbNotification('Logout error: ' + error.message, true);
            }
        });

        // Check and create tables if they don't exist
        async function setupDatabase() {
            showDbNotification('Checking database tables...');
            
            try {
                // Enable RLS on all tables and set up policies
                await setupRLS();
                
                // Load initial data
                fetchContacts();
                fetchPipeline();
                
            } catch (error) {
                console.error('Database setup error:', error);
                showDbNotification('Error setting up database: ' + error.message, true);
            }
        }

        // Set up RLS policies
        async function setupRLS() {
            try {
                // Enable RLS on all tables
                const tables = ['quotes', 'email_templates', 'site_visits', 'contacts', 'leads', 'activities'];
                
                for (const table of tables) {
                    // Check if table exists
                    const { error: checkError } = await supabase
                        .from(table)
                        .select('id')
                        .limit(1);
                    
                    if (checkError && checkError.code === '42P01') {
                        showDbNotification(`Table ${table} doesn't exist yet. It will be created when needed.`);
                        continue;
                    }
                    
                    // Enable RLS
                    const { error: rlsError } = await supabase.rpc('enable_rls', { table_name: table });
                    if (rlsError && !rlsError.message.includes('already')) {
                        console.error(`Error enabling RLS on ${table}:`, rlsError);
                    }
                }
                
                showDbNotification('Security policies configured successfully');
            } catch (error) {
                console.error('RLS setup error:', error);
                throw error;
            }
        }

        // Fetch contacts from Supabase
        async function fetchContacts() {
            try {
                showDbNotification('Loading contacts...');
                
                let { data: contacts, error } = await supabase
                    .from('contacts')
                    .select('*')
                    .order('name', { ascending: true });
                
                if (error) throw error;
                
                // Update counters
                document.getElementById('totalContacts').textContent = contacts.length;
                document.getElementById('totalClients').textContent = contacts.filter(c => c.type === 'client').length;
                document.getElementById('totalLeads').textContent = contacts.filter(c => c.type === 'lead').length;
                document.getElementById('totalSuppliers').textContent = contacts.filter(c => c.type === 'supplier').length;
                
                // Render contacts table
                contactsBody.innerHTML = '';
                contacts.forEach(contact => {
                    const row = document.createElement('tr');
                    
                    // Determine badge class based on client type
                    let badgeClass = 'badge-residential';
                    if (contact.client_type === 'commercial') badgeClass = 'badge-commercial';
                    if (contact.client_type === 'government') badgeClass = 'badge-government';
                    
                    row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(contact.name)}&background=3498db&color=fff" class="rounded-circle me-2" width="32" height="32" alt="${contact.name}">
                                <div>${contact.name}</div>
                            </div>
                        </td>
                        <td><span class="badge ${badgeClass}">${contact.client_type || 'N/A'}</span></td>
                        <td><span class="badge bg-secondary">${contact.role || 'N/A'}</span></td>
                        <td>${contact.project_count || 0} Projects</td>
                        <td>${formatDate(contact.last_contact) || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-edit"></i></button>
                        </td>
                    `;
                    
                    contactsBody.appendChild(row);
                });
                
                showDbNotification('Contacts loaded successfully');
            } catch (error) {
                console.error('Error fetching contacts:', error.message);
                contactsBody.innerHTML = `<tr><td colspan="6" class="text-center">Error loading contacts: ${error.message}</td></tr>`;
                showDbNotification('Error loading contacts: ' + error.message, true);
            }
        }
        
        // Fetch pipeline data from Supabase
        async function fetchPipeline() {
            try {
                showDbNotification('Loading pipeline data...');
                
                let { data: leads, error } = await supabase
                    .from('leads')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                // Define pipeline stages
                const stages = [
                    { id: 'lead', title: 'Lead' },
                    { id: 'qualified', title: 'Qualified' },
                    { id: 'estimate', title: 'Estimate' },
                    { id: 'contract', title: 'Contract' },
                    { id: 'progress', title: 'Progress' },
                    { id: 'complete', title: 'Complete' }
                ];
                
                // Render pipeline stages
                pipelineStages.innerHTML = '';
                stages.forEach(stage => {
                    const stageLeads = leads ? leads.filter(lead => lead.status === stage.id) : [];
                    
                    const stageCol = document.createElement('div');
                    stageCol.className = 'col-md-2';
                    stageCol.innerHTML = `
                        <div class="pipeline-stage" data-stage="${stage.id}">
                            <h6 class="text-center">${stage.title} <span class="badge bg-secondary">${stageLeads.length}</span></h6>
                            ${stageLeads.length > 0 ? stageLeads.map(lead => `
                                <div class="lead-card" data-id="${lead.id}" draggable="true">
                                    <h6>${lead.project_name}</h6>
                                    <p class="mb-1">${lead.contact_name}</p>
                                    <small class="text-muted">${lead.notes || 'No notes'}</small>
                                </div>
                            `).join('') : '<p class="text-center text-muted mt-4">No leads</p>'}
                        </div>
                    `;
                    
                    pipelineStages.appendChild(stageCol);
                });
                
                // Add drag and drop functionality
                setupDragAndDrop();
                showDbNotification('Pipeline data loaded successfully');
            } catch (error) {
                console.error('Error fetching pipeline:', error.message);
                pipelineStages.innerHTML = `<div class="col-12"><div class="alert alert-info">No pipeline data yet. Add some leads to get started.</div></div>`;
            }
        }
        
        // Set up drag and drop for pipeline
        function setupDragAndDrop() {
            const stages = document.querySelectorAll('.pipeline-stage');
            const leadCards = document.querySelectorAll('.lead-card');
            
            leadCards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', card.dataset.id);
                    setTimeout(() => card.classList.add('opacity-50'), 0);
                });
                
                card.addEventListener('dragend', () => {
                    card.classList.remove('opacity-50');
                });
            });
            
            stages.forEach(stage => {
                stage.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    stage.classList.add('drag-over');
                });
                
                stage.addEventListener('dragleave', () => {
                    stage.classList.remove('drag-over');
                });
                
                stage.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    stage.classList.remove('drag-over');
                    
                    const leadId = e.dataTransfer.getData('text/plain');
                    const newStatus = stage.dataset.stage;
                    
                    try {
                        showDbNotification('Updating lead status...');
                        
                        // Update lead status in Supabase
                        const { error } = await supabase
                            .from('leads')
                            .update({ status: newStatus })
                            .eq('id', leadId);
                            
                        if (error) throw error;
                        
                        // Refresh the pipeline view
                        fetchPipeline();
                        showDbNotification('Lead status updated successfully');
                    } catch (error) {
                        console.error('Error updating lead status:', error.message);
                        showDbNotification('Error updating lead status: ' + error.message, true);
                    }
                });
            });
        }
        
        // Generate AI email response
        generateResponseBtn.addEventListener('click', () => {
            const context = emailContext.value.trim();
            if (!context) {
                showDbNotification('Please provide some context for the email response', true);
                return;
            }
            
            // Simple rule-based response generation
            let response = "";
            
            if (context.toLowerCase().includes('quote') || context.toLowerCase().includes('price')) {
                response = "Thank you for your inquiry about our services. Based on your project requirements, I've prepared a detailed quote for your review. The quote includes all materials and labor costs, with a breakdown of each phase of the project. We would be happy to discuss any aspects of this quote and make adjustments based on your feedback.";
            } else if (context.toLowerCase().includes('schedule') || context.toLowerCase().includes('timeline')) {
                response = "Thank you for asking about our schedule availability. We typically require 2-3 weeks of lead time for new projects, depending on the scope of work. I can check our current schedule and provide you with specific available start dates. Would you prefer a morning or afternoon site visit for our initial consultation?";
            } else if (context.toLowerCase().includes('problem') || context.toLowerCase().includes('issue')) {
                response = "I'm sorry to hear you're experiencing this issue. Our team takes all concerns seriously and we want to resolve this promptly. Could you please provide more details about the problem, including when it started and any specific areas affected? I will immediately dispatch our project manager to assess the situation and develop a solution.";
            } else {
                response = "Thank you for reaching out to Sierra Suites. We appreciate your interest in our construction services. Our team specializes in high-quality residential and commercial projects, and we would be delighted to discuss how we can assist with your needs. Would you be available for a brief call this week to discuss your project in more detail?";
            }
            
            response += "\n\nBest regards,\n[Your Name]\nSierra Suites Construction";
            
            emailResponse.innerHTML = response;
        });
        
        // Copy email response
        copyEmailBtn.addEventListener('click', () => {
            const range = document.createRange();
            range.selectNode(emailResponse);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            
            showDbNotification('Response copied to clipboard!');
        });
        
        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    loginScreen.style.display = 'none';
                    signupScreen.style.display = 'none';
                    appContainer.style.display = 'block';
                    userName.textContent = session.user.email;
                    setupDatabase();
                }
            });
            
            // Set up filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filter = this.dataset.filter;
                    console.log('Filtering by:', filter);
                });
            });

            // Set up pipeline analytics toggle
            document.getElementById('pipelineAnalyticsBtn').addEventListener('click', function() {
                document.getElementById('pipelineAnalytics').classList.toggle('d-none');
            });
        });
    </script>
</body>
</html>